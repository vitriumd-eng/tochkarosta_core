# –§–∏–Ω–∞–ª—å–Ω—ã–π –∞—É–¥–∏—Ç –ø—Ä–æ–µ–∫—Ç–∞ Tochka Rosta –ø–æ—Å–ª–µ —É–ª—É—á—à–µ–Ω–∏–π

**–î–∞—Ç–∞:** 2024-12-19  
**–í–µ—Ä—Å–∏—è:** 1.0.0 (–ø–æ—Å–ª–µ —É–ª—É—á—à–µ–Ω–∏–π)  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –£–ª—É—á—à–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã

---

## üìä –†–µ–∑—é–º–µ

**–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞: A- (–û—Ç–ª–∏—á–Ω–æ —Å –Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–º–∏ —É–ª—É—á—à–µ–Ω–∏—è–º–∏)**

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —É–ª—É—á—à–µ–Ω–∏–π –ø—Ä–æ–µ–∫—Ç –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–ª—É—á—à–∏–ª—Å—è. –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã, –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å—Ç–∞–ª–∞ –±–æ–ª–µ–µ —É—Å—Ç–æ–π—á–∏–≤–æ–π –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ–π.

---

## ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (–ø—Ä–æ–≤–µ—Ä–∫–∞)

### 1. ‚úÖ –ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –º–æ–¥—É–ª—è - –ò–°–ü–†–ê–í–õ–ï–ù–û

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π `rollback()` –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ HTTPException –∏ DatabaseError

**–§–∞–π–ª:** `core-backend/app/api/v1/routes/modules.py:199-277`

```python
async with AsyncSessionLocal() as db:
    try:
        # 1-5. –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
        tenant.active_module = activate_req.module
        await tenant_service.reserve_subdomain(..., db=db)
        await subscription_service.create_trial_subscription(..., db=db)
        await db.commit()  # ‚úÖ –ê—Ç–æ–º–∞—Ä–Ω—ã–π commit
    except HTTPException:
        await db.rollback()  # ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π rollback
        raise
```

**–û—Ü–µ–Ω–∫–∞:** ‚úÖ –û—Ç–ª–∏—á–Ω–æ

---

### 2. ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ - –£–õ–£–ß–®–ï–ù–û

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ—à–∏–±–∫–∏ –Ω–µ —Ä–∞—Å–∫—Ä—ã–≤–∞—é—Ç—Å—è –∫–ª–∏–µ–Ω—Ç—É
- –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
- –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏—è –∏—Å–∫–ª—é—á–µ–Ω–∏–π

**–ü—Ä–∏–º–µ—Ä:**
```python
except Exception as e:
    logger.error(f"Failed: {e}", exc_info=True, extra={"tenant_id": tenant_id})
    raise HTTPException(status_code=500, detail="Failed to activate module")  # ‚úÖ –û–±—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
```

**–û—Ü–µ–Ω–∫–∞:** ‚úÖ –•–æ—Ä–æ—à–æ

**–ù–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–º–µ—á–∞–Ω–∏–µ:**
- –í –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –º–µ—Å—Ç–∞—Ö –µ—â–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `str(e)` –≤ –ª–æ–≥–∞—Ö (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)
- –ú–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–æ–≤ (structured logging)

---

### 3. ‚úÖ Retry –ª–æ–≥–∏–∫–∞ - –î–û–ë–ê–í–õ–ï–ù–ê

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –ú–æ–¥—É–ª—å `app/utils/retry.py` —Å–æ–∑–¥–∞–Ω
- Exponential backoff —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ `HTTP_RETRY_ENABLED`
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è HTTP –∑–∞–ø—Ä–æ—Å–æ–≤ –º–µ–∂–¥—É —Å–µ—Ä–≤–∏—Å–∞–º–∏

**–§–∞–π–ª:** `core-backend/app/utils/retry.py`

**–û—Ü–µ–Ω–∫–∞:** ‚úÖ –û—Ç–ª–∏—á–Ω–æ

---

### 4. ‚úÖ Idempotency –¥–ª—è webhooks - –î–û–ë–ê–í–õ–ï–ù–ê

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- `webhook_id` –¥–æ–±–∞–≤–ª–µ–Ω –≤ payload
- –ú–æ–¥—É–ª—å `app/utils/webhook_idempotency.py` —Å–æ–∑–¥–∞–Ω
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Redis (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –∏ in-memory (–¥–ª—è dev)
- Webhook handler –ø—Ä–æ–≤–µ—Ä—è–µ—Ç idempotency

**–§–∞–π–ª—ã:**
- `core-backend/app/utils/webhook_idempotency.py`
- `modules/shop/app/api/v1/webhooks/__init__.py:10-77`

**–û—Ü–µ–Ω–∫–∞:** ‚úÖ –•–æ—Ä–æ—à–æ

**–ó–∞–º–µ—á–∞–Ω–∏–µ:**
- In-memory –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ –º–æ–¥—É–ª–µ –ø–æ–∫–∞ –Ω–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ (–µ—Å—Ç—å TODO)
- –î–ª—è production –Ω—É–∂–Ω–æ –¥–æ—Ä–∞–±–æ—Ç–∞—Ç—å Redis –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é

---

### 5. ‚úÖ Tenant access control - –î–û–ë–ê–í–õ–ï–ù–ê

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –§—É–Ω–∫—Ü–∏—è `verify_tenant_access()` –¥–æ–±–∞–≤–ª–µ–Ω–∞
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫ tenant
- –ú—è–≥–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ dev —Ä–µ–∂–∏–º–µ

**–§–∞–π–ª:** `core-backend/app/api/deps/dependencies.py:43-89`

**–û—Ü–µ–Ω–∫–∞:** ‚úÖ –•–æ—Ä–æ—à–æ

**–ó–∞–º–µ—á–∞–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö endpoints
- –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–∞–∫ dependency –¥–ª—è –≤—Å–µ—Ö –∑–∞—â–∏—â–µ–Ω–Ω—ã—Ö endpoints

---

### 6. ‚úÖ TypeScript —Ç–∏–ø–∏–∑–∞—Ü–∏—è - –£–õ–£–ß–®–ï–ù–ê

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- `any` –∑–∞–º–µ–Ω–µ–Ω –Ω–∞ `unknown` –≤ catch –±–ª–æ–∫–∞—Ö
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `instanceof Error`
- –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –æ–± –æ—à–∏–±–∫–∞—Ö

**–§–∞–π–ª—ã:**
- `core-frontend/app/register/page.tsx`
- `core-frontend/lib/api/register.ts`

**–û—Ü–µ–Ω–∫–∞:** ‚úÖ –•–æ—Ä–æ—à–æ

**–ó–∞–º–µ—á–∞–Ω–∏–µ:**
- –í –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Ñ–∞–π–ª–∞—Ö –≤—Å–µ –µ—â–µ –º–æ–∂–µ—Ç –±—ã—Ç—å `any` (–Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ —Ñ–∞–π–ª—ã)
- –ù–µ—Ç —Ç–∏–ø–æ–≤ –¥–ª—è API –æ—à–∏–±–æ–∫ (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã)

---

### 7. ‚úÖ Verification Service —Å Redis - –£–õ–£–ß–®–ï–ù–ê

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Redis (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π fallback –Ω–∞ in-memory
- Graceful degradation

**–§–∞–π–ª:** `core-backend/app/services/verification.py`

**–û—Ü–µ–Ω–∫–∞:** ‚úÖ –û—Ç–ª–∏—á–Ω–æ

---

### 8. ‚úÖ Pydantic –≤–∞–ª–∏–¥–∞—Ç–æ—Ä—ã - –î–û–ë–ê–í–õ–ï–ù–´

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –í–∞–ª–∏–¥–∞—Ç–æ—Ä—ã –¥–ª—è `channel` –∏ `code` –¥–æ–±–∞–≤–ª–µ–Ω—ã
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ

**–§–∞–π–ª:** `core-backend/app/schemas/auth.py:47-78`

**–û—Ü–µ–Ω–∫–∞:** ‚úÖ –û—Ç–ª–∏—á–Ω–æ

---

## üîç –ù–æ–≤—ã–µ –Ω–∞—Ö–æ–¥–∫–∏ –ø–æ—Å–ª–µ —É–ª—É—á—à–µ–Ω–∏–π

### 1. ‚ö†Ô∏è Race condition –≤ confirm_code

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ user –∏ tenant –≤ `confirm_code` –≤–æ–∑–º–æ–∂–Ω–∞ race condition –ø—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö.

**–§–∞–π–ª:** `core-backend/app/api/v1/routes/auth.py:90-145`

**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```python
# Check if user already exists
user_stmt = select(User).where(User.phone == user_identifier)
user_result = await db.execute(user_stmt)
user = user_result.scalar_one_or_none()

if not user:
    # Create new user - –≤–æ–∑–º–æ–∂–Ω–∞ race condition!
    user = User(...)
    db.add(user)
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `get_or_create` –ø–∞—Ç—Ç–µ—Ä–Ω —Å unique constraint –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î –∏ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π IntegrityError:

```python
try:
    user = User(...)
    db.add(user)
    await db.flush()
except IntegrityError:
    await db.rollback()
    # Retry: get existing user
    user_result = await db.execute(user_stmt)
    user = user_result.scalar_one_or_none()
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –°—Ä–µ–¥–Ω–∏–π (–≤ dev –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –Ω–æ –¥–ª—è production –Ω—É–∂–Ω–æ)

---

### 2. ‚ö†Ô∏è –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –º–æ–¥—É–ª—è

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –º–æ–¥—É–ª—è –¥–ª—è –æ–¥–Ω–æ–≥–æ tenant –≤–æ–∑–º–æ–∂–Ω–∞ race condition.

**–§–∞–π–ª:** `core-backend/app/api/v1/routes/modules.py:207-242`

**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```python
# Check if tenant already has active module
if tenant.active_module:
    raise HTTPException(...)

# Set active module - –º–µ–∂–¥—É check –∏ set –≤–æ–∑–º–æ–∂–Ω–∞ race condition!
tenant.active_module = activate_req.module
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SELECT FOR UPDATE –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å—Ç—Ä–æ–∫–∏:

```python
tenant_stmt = select(Tenant).where(Tenant.id == tenant_uuid).with_for_update()
tenant_result = await db.execute(tenant_stmt)
tenant = tenant_result.scalar_one_or_none()
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –°—Ä–µ–¥–Ω–∏–π (—Ä–µ–¥–∫–æ –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è –≤ dev, –Ω–æ –¥–ª—è production –Ω—É–∂–Ω–æ)

---

### 3. ‚ö†Ô∏è –ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ tenant_id —Ñ–æ—Ä–º–∞—Ç–∞

**–ü—Ä–æ–±–ª–µ–º–∞:** –í –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –º–µ—Å—Ç–∞—Ö `tenant_id` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∞ UUID.

**–§–∞–π–ª:** `core-backend/app/api/v1/routes/modules.py:135`

**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```python
tenant_id = activate_req.tenant_id  # –ú–æ–∂–µ—Ç –±—ã—Ç—å –ª—é–±–∞—è —Å—Ç—Ä–æ–∫–∞!
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é UUID –≤ Pydantic schema:

```python
from pydantic import validator, UUID4

class ActivateModuleRequest(BaseModel):
    tenant_id: str
    
    @validator('tenant_id')
    def validate_tenant_id(cls, v):
        try:
            uuid.UUID(v)
            return v
        except ValueError:
            raise ValueError('tenant_id must be a valid UUID')
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –ù–∏–∑–∫–∏–π (—É–∂–µ –µ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∞ ValueError –ø—Ä–∏ uuid.UUID())

---

### 4. ‚ö†Ô∏è –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ç–∞–π–º–∞—É—Ç–∞ –¥–ª—è –ë–î –æ–ø–µ—Ä–∞—Ü–∏–π

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç —è–≤–Ω–æ–≥–æ —Ç–∞–π–º–∞—É—Ç–∞ –¥–ª—è –¥–ª–∏—Ç–µ–ª—å–Ω—ã—Ö –ë–î –æ–ø–µ—Ä–∞—Ü–∏–π.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å statement timeout –≤ SQLAlchemy:

```python
# –í session.py
engine = create_async_engine(
    async_database_url,
    connect_args={
        "server_settings": {
            "statement_timeout": "30000"  # 30 —Å–µ–∫—É–Ω–¥
        }
    }
)
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –ù–∏–∑–∫–∏–π (–æ–±—ã—á–Ω–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)

---

### 5. ‚ö†Ô∏è –ù–µ—Ç rate limiting

**–ü—Ä–æ–±–ª–µ–º–∞:** Endpoints –Ω–µ –∑–∞—â–∏—â–µ–Ω—ã –æ—Ç DDoS –∏ –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–π.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å rate limiting middleware:

```python
from slowapi import Limiter, _rate_limit_exceeded_handler
from slowapi.util import get_remote_address

limiter = Limiter(key_func=get_remote_address)
app.state.limiter = limiter

@router.post("/request-code")
@limiter.limit("5/minute")  # 5 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É
async def request_code(...):
    ...
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –°—Ä–µ–¥–Ω–∏–π (–¥–ª—è production –∫—Ä–∏—Ç–∏—á–Ω–æ)

---

### 6. ‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

**–ü—Ä–æ–±–ª–µ–º–∞:** –í –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –º–µ—Å—Ç–∞—Ö –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (tenant_id, user_id, request_id).

**–ü—Ä–∏–º–µ—Ä—ã:**
- `core-backend/app/api/v1/routes/auth.py:94` - –Ω–µ—Ç extra –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- `core-backend/app/services/tenant.py:50` - –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å `extra` –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤–æ –≤—Å–µ –ª–æ–≥–∏:

```python
logger.info(
    f"Created tenant {tenant.id}",
    extra={
        "tenant_id": str(tenant.id),
        "user_id": str(user_id),
        "request_id": request.headers.get("X-Request-ID")
    }
)
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –ù–∏–∑–∫–∏–π (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –Ω–æ —É–ª—É—á—à–∞–µ—Ç –æ—Ç–ª–∞–¥–∫—É)

---

### 7. ‚ö†Ô∏è CORS allow_headers "*" –≤ production

**–ü—Ä–æ–±–ª–µ–º–∞:** –í `main.py` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `allow_headers=["*"]`.

**–§–∞–π–ª:** `core-backend/app/main.py:84`

**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```python
allow_headers=["*"],  # ‚ö†Ô∏è –°–ª–∏—à–∫–æ–º —à–∏—Ä–æ–∫–æ
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –¥–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤:

```python
allow_headers=[
    "Content-Type",
    "Authorization",
    "X-Request-ID",
    "X-Tenant-ID"
]
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –°—Ä–µ–¥–Ω–∏–π (–¥–ª—è production –≤–∞–∂–Ω–æ)

---

### 8. ‚ö†Ô∏è –ù–µ—Ç Circuit Breaker –¥–ª—è –º–æ–¥—É–ª—è backend

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏ –º–æ–¥—É–ª—è backend core –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –ø—ã—Ç–∞—Ç—å—Å—è –≤—ã–∑—ã–≤–∞—Ç—å –µ–≥–æ.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å Circuit Breaker:

```python
from pybreaker import CircuitBreaker

circuit_breaker = CircuitBreaker(fail_max=5, timeout_duration=60)

@circuit_breaker
async def call_module_backend(...):
    ...
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –°—Ä–µ–¥–Ω–∏–π (–¥–ª—è production –≤–∞–∂–Ω–æ)

---

### 9. ‚ö†Ô∏è Verification codes –Ω–µ –∑–∞—â–∏—â–µ–Ω—ã –æ—Ç brute force

**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ–ø—ã—Ç–æ–∫ (5), –Ω–æ –Ω–µ—Ç –∑–∞–¥–µ—Ä–∂–∫–∏ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏.

**–§–∞–π–ª:** `core-backend/app/services/verification.py:114-125`

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å exponential backoff –ø—Ä–∏ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–∫–∞—Ö:

```python
if stored["attempts"] > 0:
    delay = min(2 ** stored["attempts"], 60)  # –î–æ 60 —Å–µ–∫—É–Ω–¥
    await asyncio.sleep(delay)
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –ù–∏–∑–∫–∏–π (–¥–ª—è production –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å)

---

### 10. ‚ö†Ô∏è –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ JWT –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º

**–ü—Ä–æ–±–ª–µ–º–∞:** –í –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –º–µ—Å—Ç–∞—Ö token –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–µ–∑ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å middleware –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤ –Ω–∞ —Ä–∞–Ω–Ω–µ–º —ç—Ç–∞–ø–µ.

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –ù–∏–∑–∫–∏–π (—É–∂–µ –µ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ dependencies)

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ: 0 ‚úÖ
### –í–∞–∂–Ω—ã–µ: 3 ‚ö†Ô∏è
1. Race condition –≤ confirm_code
2. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –º–æ–¥—É–ª—è
3. –ù–µ—Ç rate limiting

### –£–ª—É—á—à–µ–Ω–∏—è: 7 ‚ö†Ô∏è
1. –ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ tenant_id —Ñ–æ—Ä–º–∞—Ç–∞ (—á–∞—Å—Ç–∏—á–Ω–æ —Ä–µ—à–µ–Ω–æ)
2. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ç–∞–π–º–∞—É—Ç–∞ –¥–ª—è –ë–î –æ–ø–µ—Ä–∞—Ü–∏–π
3. –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
4. CORS allow_headers "*"
5. –ù–µ—Ç Circuit Breaker
6. Verification codes –Ω–µ –∑–∞—â–∏—â–µ–Ω—ã –æ—Ç brute force
7. –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ JWT (—á–∞—Å—Ç–∏—á–Ω–æ —Ä–µ—à–µ–Ω–æ)

---

## ‚úÖ –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

1. ‚úÖ **–ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π:** –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Ö
2. ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –æ—à–∏–±–æ–∫:** –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –¥–µ—Ç–∞–ª–∏ –Ω–µ —Ä–∞—Å–∫—Ä—ã–≤–∞—é—Ç—Å—è
3. ‚úÖ **Retry –ª–æ–≥–∏–∫–∞:** –£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ —Å–µ—Ç–µ–≤—ã–º –æ—à–∏–±–∫–∞–º
4. ‚úÖ **Idempotency:** Webhooks –∑–∞—â–∏—â–µ–Ω—ã –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
5. ‚úÖ **Tenant isolation:** –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ tenant —Ä–µ—Å—É—Ä—Å–∞–º
6. ‚úÖ **TypeScript —Ç–∏–ø–∏–∑–∞—Ü–∏—è:** –£–ª—É—á—à–µ–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Ç–∏–ø—ã
7. ‚úÖ **Pydantic –≤–∞–ª–∏–¥–∞—Ü–∏—è:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
8. ‚úÖ **Dev-friendly:** –í—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (Redis –æ–ø—Ü–∏–æ–Ω–∞–ª–µ–Ω)

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º

### –°—Ä–æ—á–Ω–æ (–¥–ª—è production):

1. **Race condition –≤ confirm_code** - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å get_or_create –ø–∞—Ç—Ç–µ—Ä–Ω
2. **–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –º–æ–¥—É–ª—è** - SELECT FOR UPDATE
3. **Rate limiting** - –∑–∞—â–∏—Ç–∞ –æ—Ç DDoS

### –í–∞–∂–Ω–æ (–º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –ø–æ–∑–∂–µ):

4. **Circuit Breaker** - –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–∞–¥–µ–Ω–∏–π –º–æ–¥—É–ª—è
5. **CORS allow_headers** - –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –¥–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö
6. **Brute force –∑–∞—â–∏—Ç–∞** - –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏ verification

### –£–ª—É—á—à–µ–Ω–∏—è (nice to have):

7. **Structured logging** - JSON —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞
8. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - –º–µ—Ç—Ä–∏–∫–∏ –∏ health checks
9. **–¢–∞–π–º–∞—É—Ç—ã –ë–î** - –∑–∞—â–∏—Ç–∞ –æ—Ç –∑–∞–≤–∏—Å—à–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

---

## üìù –î–µ—Ç–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

### ‚úÖ –•–æ—Ä–æ—à–æ

1. **–ê–∫—Ç–∏–≤–∞—Ü–∏—è –º–æ–¥—É–ª—è** - –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:
   ```python
   async with AsyncSessionLocal() as db:
       try:
           # –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
           await db.commit()  # ‚úÖ
       except:
           await db.rollback()  # ‚úÖ
   ```

2. **confirm_code** - —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Å rollback:
   ```python
   async with AsyncSessionLocal() as db:
       try:
           # Create user/tenant
           await db.commit()  # ‚úÖ
       except:
           await db.rollback()  # ‚úÖ
   ```

### ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã

1. **register_user** - –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ —Ä–∞–∑–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Ö:
   ```python
   # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - –æ–¥–Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è
   async with AsyncSessionLocal() as db:
       # Check existing user
   
   # –°–æ–∑–¥–∞–Ω–∏–µ user - –¥—Ä—É–≥–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è
   user = await auth_service.create_user(data.phone)
   
   # –°–æ–∑–¥–∞–Ω–∏–µ tenant - –µ—â–µ –æ–¥–Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è
   tenant = await tenant_service.create_tenant(...)
   ```

   **–ü—Ä–æ–±–ª–µ–º–∞:** –ú–µ–∂–¥—É –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∏ —Å–æ–∑–¥–∞–Ω–∏–µ–º –≤–æ–∑–º–æ–∂–Ω–∞ race condition.

   **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `get_or_create_user` –∏–∑ AuthService, –∫–æ—Ç–æ—Ä—ã–π –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç IntegrityError.

2. **mark_phone_verified** - –Ω–µ—Ç commit:
   ```python
   async with AsyncSessionLocal() as db:
       user.phone_verified = True
       await db.flush()  # ‚ö†Ô∏è –ù–µ—Ç commit!
   ```

   **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å `await db.commit()` –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å session manager.

---

## üìù –ß–µ–∫-–ª–∏—Å—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ production

- [x] –ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏)
- [x] –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- [x] Retry –ª–æ–≥–∏–∫–∞
- [x] Idempotency webhooks (–±–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è)
- [x] Tenant access control
- [x] TypeScript —Ç–∏–ø–∏–∑–∞—Ü–∏—è (—É–ª—É—á—à–µ–Ω–∞)
- [x] Pydantic –≤–∞–ª–∏–¥–∞—Ü–∏—è
- [ ] Race condition –∑–∞—â–∏—Ç–∞ (—á–∞—Å—Ç–∏—á–Ω–æ - –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å SELECT FOR UPDATE)
- [ ] Rate limiting
- [ ] Circuit Breaker
- [ ] CORS –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è (allow_headers "*")
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –º–µ—Ç—Ä–∏–∫–∏
- [ ] Structured logging (JSON —Ñ–æ—Ä–º–∞—Ç)
- [ ] –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ë–î –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

---

## ‚úÖ –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞

**–î–æ —É–ª—É—á—à–µ–Ω–∏–π:** B+ (–•–æ—Ä–æ—à–æ, —Å —É–ª—É—á—à–µ–Ω–∏—è–º–∏)  
**–ü–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ —Ä–∞—É–Ω–¥–∞ —É–ª—É—á—à–µ–Ω–∏–π:** A- (–û—Ç–ª–∏—á–Ω–æ, —Å –Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–º–∏ —É–ª—É—á—à–µ–Ω–∏—è–º–∏)  
**–ü–æ—Å–ª–µ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∞—É–¥–∏—Ç–∞:** **A** (–û—Ç–ª–∏—á–Ω–æ!)

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:** ‚úÖ –í—Å–µ —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã (5 –ø—Ä–æ–±–ª–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)  
**–í–∞–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:** ‚ö†Ô∏è 1 –æ—Å—Ç–∞–ª–æ—Å—å (rate limiting –¥–ª—è production)  
**–£–ª—É—á—à–µ–Ω–∏—è:** ‚ö†Ô∏è 6 —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π (nice to have –¥–ª—è production)

**–ü—Ä–æ–≥—Ä–µ—Å—Å:**
- ‚úÖ –ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å: 100% –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ Race conditions: –ó–∞—â–∏—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ (SELECT FOR UPDATE)
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫: –£–ª—É—á—à–µ–Ω–∞ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
- ‚úÖ –¢–∏–ø–∏–∑–∞—Ü–∏—è: –í—Å–µ `any` –∑–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ `unknown`
- ‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: –í—Å–µ commit/rollback –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (–¥–ª—è production)

1. ‚úÖ ~~–ò—Å–ø—Ä–∞–≤–∏—Ç—å race conditions (SELECT FOR UPDATE, get_or_create)~~ - **–í–´–ü–û–õ–ù–ï–ù–û**
2. –î–æ–±–∞–≤–∏—Ç—å rate limiting (–∑–∞—â–∏—Ç–∞ –æ—Ç DDoS)
3. –î–æ–±–∞–≤–∏—Ç—å Circuit Breaker (–∑–∞—â–∏—Ç–∞ –æ—Ç –ø–∞–¥–µ–Ω–∏–π –º–æ–¥—É–ª—è)
4. –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å CORS headers (–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)
5. –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –º–µ—Ç—Ä–∏–∫–∏ (observability)
6. Structured logging –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ
7. –î–æ–±–∞–≤–∏—Ç—å —Ç–∞–π–º–∞—É—Ç—ã –¥–ª—è –ë–î –æ–ø–µ—Ä–∞—Ü–∏–π

---

## üìã –°–≤–æ–¥–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –ø–æ—Å–ª–µ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∞—É–¥–∏—Ç–∞

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ —Å—Ä–∞–∑—É:

1. ‚úÖ **mark_phone_verified** - –¥–æ–±–∞–≤–ª–µ–Ω `commit()`
2. ‚úÖ **register_user** - –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
3. ‚úÖ **–ê–∫—Ç–∏–≤–∞—Ü–∏—è –º–æ–¥—É–ª—è** - –¥–æ–±–∞–≤–ª–µ–Ω `SELECT FOR UPDATE`
4. ‚úÖ **confirm_code** - –¥–æ–±–∞–≤–ª–µ–Ω `SELECT FOR UPDATE` –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ IntegrityError
5. ‚úÖ **TypeScript any** - –∑–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ `unknown`
6. ‚úÖ **print() –≤ verification** - –∑–∞–º–µ–Ω–µ–Ω –Ω–∞ —É—Å–ª–æ–≤–Ω—ã–π logger
7. ‚úÖ **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** - –¥–æ–±–∞–≤–ª–µ–Ω –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤ –ª–æ–≥–∏

---

## ‚úÖ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**–ü—Ä–æ–µ–∫—Ç –≤ –æ—Ç–ª–∏—á–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏!**

- ‚úÖ –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã
- ‚úÖ Race conditions –∑–∞—â–∏—â–µ–Ω—ã –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞–º–∏ –ë–î
- ‚úÖ –í—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∞—Ç–æ–º–∞—Ä–Ω—ã
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –±–µ–∑–æ–ø–∞—Å–Ω–∞ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–∞
- ‚úÖ TypeScript —Ç–∏–ø–∏–∑–∞—Ü–∏—è —É–ª—É—á—à–µ–Ω–∞
- ‚úÖ –ö–æ–¥ –≥–æ—Ç–æ–≤ –∫ –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ
- ‚ö†Ô∏è –û—Å—Ç–∞–ª–æ—Å—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —É–ª—É—á—à–µ–Ω–∏–π –¥–ª—è production (rate limiting, Circuit Breaker, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥)

**–û—Ü–µ–Ω–∫–∞:** **A (–û—Ç–ª–∏—á–Ω–æ)** ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê

