# АУДИТ АРХИТЕКТУРЫ: ИЗОЛЯЦИЯ БАЗ ДАННЫХ

## Дата: 2025-11-16

## АРХИТЕКТУРНОЕ ПРАВИЛО

**Ядро платформы (CORE) и каждый модуль должны использовать РАЗНЫЕ базы данных.**

## РЕЗУЛЬТАТЫ АУДИТА

### ✅ ПРАВИЛЬНЫЕ РЕАЛИЗАЦИИ

#### 1. Модуль shop использует SDK для взаимодействия с ядром
**Файлы:**
- `modules/shop/backend/main.py`
- `modules/shop/backend/api/products.py`
- `modules/shop/backend/services/product_service.py`

**Статус:** ✅ ПРАВИЛЬНО
- Модуль импортирует только функции из `app.modules.sdk`
- Нет прямых импортов из core (`from app.db`, `from app.models`, и т.д.)
- Используются только функции SDK:
  - `get_subscription_status()`
  - `get_tenant_info()`
  - `get_tenant_database_url()`

#### 2. SDK правильно изолирован
**Файл:** `core-backend/app/modules/sdk.py`

**Статус:** ✅ ПРАВИЛЬНО
- SDK работает с core БД (это правильно, т.к. он часть ядра)
- SDK предоставляет функции для модулей
- Модули не имеют прямого доступа к core БД

### ⚠️ НАЙДЕННЫЕ ПРОБЛЕМЫ

#### Проблема #1: get_tenant_database_url() не реализована
**Файл:** `core-backend/app/modules/sdk.py:69-83`

**Описание:**
- Функция `get_tenant_database_url()` возвращает только заглушку
- Не создает реальное подключение к БД модуля
- Модули не могут получить свой DATABASE_URL

**Риск:** КРИТИЧЕСКИЙ
- Модули не могут подключиться к своей БД
- Все модули могут использовать core БД по умолчанию
- Нарушение архитектурного правила

**Решение:**
- Реализовать функцию для получения/создания БД для tenant+module
- Использовать отдельную БД для каждого модуля
- Возвращать правильный DATABASE_URL

#### Проблема #2: Модуль shop не подключается к своей БД
**Файлы:**
- `modules/shop/backend/main.py`
- `modules/shop/backend/services/product_service.py`

**Описание:**
- Модуль shop имеет модели (`models/product.py`)
- Но нет кода для подключения к БД
- Функция `get_tenant_database_url()` используется, но не реализована

**Риск:** ВЫСОКИЙ
- Модуль не может работать со своими данными
- Может использовать core БД по умолчанию

**Решение:**
- Реализовать подключение к БД модуля через `get_tenant_database_url()`
- Создать отдельную сессию БД для модуля
- Использовать свою БД для всех операций модуля

#### Проблема #3: Нет проверки на смешивание БД
**Описание:**
- Нет валидации, что модуль не использует core DATABASE_URL
- Нет проверки, что модуль не импортирует core модели
- Нет защиты от прямого доступа к core БД

**Риск:** СРЕДНИЙ
- Возможность случайного нарушения архитектуры
- Сложность диагностики проблем

**Решение:**
- Добавить валидацию в SDK
- Проверять, что модули не используют core DATABASE_URL
- Запретить импорты core моделей в модулях

## РЕКОМЕНДАЦИИ

### Критические (исправить немедленно)

1. **Реализовать get_tenant_database_url()**
   - Должна возвращать реальный DATABASE_URL для tenant+module
   - Использовать отдельную БД: `{tenant_id}_{module_id}`
   - Создавать БД при первом использовании модуля

2. **Реализовать подключение к БД в модуле shop**
   - Использовать `get_tenant_database_url()` из SDK
   - Создать отдельную сессию БД для модуля
   - Использовать свою БД для всех операций

3. **Добавить валидацию архитектуры**
   - Проверять, что модули не импортируют core модели
   - Проверять, что модули не используют core DATABASE_URL
   - Предупреждать о нарушениях

### Важные (исправить в ближайшее время)

4. **Документировать архитектуру БД**
   - Описать структуру БД для модулей
   - Описать процесс создания БД для модуля
   - Описать миграции модулей

5. **Добавить тесты изоляции**
   - Тесты, что модули не используют core БД
   - Тесты, что модули не импортируют core модели
   - Тесты, что SDK правильно изолирует доступ

### Желательные

6. **Автоматизированная проверка архитектуры**
   - CI/CD проверка на смешивание БД
   - Линтер для проверки импортов
   - Валидация при деплое модулей

## ТЕКУЩЕЕ СОСТОЯНИЕ

### ✅ Что работает правильно:
- SDK изолирован и предоставляет функции для модулей
- Модули используют только SDK (нет прямых импортов core)
- Архитектура в целом правильная

### ❌ Что требует исправления:
- `get_tenant_database_url()` не реализована
- Модуль shop не подключается к своей БД
- Нет валидации архитектурных правил

## ВЫВОД

**Архитектура в целом правильная**, но есть критическая проблема:
- Модули правильно используют SDK
- Но SDK не предоставляет функциональность для подключения к БД модуля
- Модули не могут работать со своими данными

**Приоритет:** КРИТИЧЕСКИЙ
**Действие:** Реализовать `get_tenant_database_url()` и подключение к БД в модулях

