# АРХИТЕКТУРНЫЕ ПРАВИЛА: ИЗОЛЯЦИЯ БАЗ ДАННЫХ

## КРИТИЧЕСКОЕ ПРАВИЛО

**Ядро платформы (CORE) и каждый модуль должны использовать РАЗНЫЕ базы данных.**

---

## ПРАВИЛА ДЛЯ CURSOR

### 1. Всегда проверять изоляцию БД

Cursor должен:
- ✅ Проверять, чтобы модуль использовал свою собственную БД и собственные миграции
- ✅ Никогда не сохранять данные модуля в core-базу
- ✅ Никогда не использовать модели, схемы или таблицы ядра внутри модулей
- ✅ Никогда не генерировать код, который соединяет модуль с core DATABASE_URL
- ✅ Проверять, что миграции модуля не применяются к core-базе

### 2. Всегда проверять DATABASE_URL

Cursor должен всегда проверять:
- ✅ DATABASE_URL модуля указывает на отдельную БД
- ✅ DATABASE_URL ядра указывает на core-базу
- ✅ Миграции не смешиваются
- ✅ ORM/SQLAlchemy/Pydantic модели не пересекают границы модулей

### 3. При обнаружении смешивания БД

Cursor должен:
- ⛔ Немедленно остановиться
- ⛔ Сообщить пользователю о нарушении архитектурных правил
- ⛔ Предложить корректное решение с полной изоляцией модульной БД

### 4. Обязательно помнить

- Модули должны быть полностью независимыми (plug-and-play)
- Модули могут располагаться на других серверах или использовать другие SQL-движки
- Ядро платформы не знает о схеме модулей
- Модули общаются с ядром только через SDK и API

### 5. Предупреждение при нарушении

Если пользователь просит объединить БД или использовать core-модели в модуле — Cursor должен предупредить, что это нарушает архитектуру платформы.

---

## СТРУКТУРА БД

### Core база данных
```
DATABASE_URL=postgresql://user:password@host:5432/modular_saas_core
```

**Таблицы core:**
- `users` - пользователи платформы
- `tenants` - арендаторы (компании)
- `subscriptions` - подписки
- `modules_registry` - реестр модулей
- `tenant_domains` - домены арендаторов
- `platform_content` - контент платформы

### Модульная база данных
```
DATABASE_URL=postgresql://user:password@host:5432/{tenant_id}_{module_id}
```

**Примеры:**
- `tenant_123_shop` - БД для модуля shop арендатора 123
- `tenant_456_events` - БД для модуля events арендатора 456

**Таблицы модуля:**
- Модуль определяет свои собственные таблицы
- Каждый модуль имеет свою схему
- Core не знает о таблицах модулей

---

## SDK ДЛЯ МОДУЛЕЙ

Модули должны использовать только функции из SDK:

```python
from app.modules.sdk import (
    get_subscription_status,  # Проверка подписки
    get_tenant_info,          # Информация о арендаторе
    get_tenant_database_url,  # Получить DATABASE_URL для модуля
    check_dependencies,       # Проверка зависимостей
    verify_module_token,      # Проверка токена модуля
    notify_tenant             # Уведомления
)
```

### Запрещено в модулях:

```python
# ❌ ЗАПРЕЩЕНО
from app.db.session import get_db  # Прямой доступ к core БД
from app.models.tenant import Tenant  # Импорт core моделей
from app.db.schemas import *  # Импорт core схем
DATABASE_URL = "postgresql://..."  # Использование core DATABASE_URL
```

### Разрешено в модулях:

```python
# ✅ РАЗРЕШЕНО
from app.modules.sdk import get_tenant_database_url  # Использование SDK
# Получение своей БД через SDK
db_config = await get_tenant_database_url(tenant_id, module_id)
```

---

## ПРОВЕРКА АРХИТЕКТУРЫ

### Автоматические проверки

При работе с модулями Cursor должен проверить:

1. **Импорты:**
   ```bash
   grep -r "from app\.db\|from app\.models\|from app\.schemas" modules/
   # Не должно быть результатов
   ```

2. **DATABASE_URL:**
   ```bash
   grep -r "DATABASE_URL.*modular_saas_core" modules/
   # Не должно быть результатов
   ```

3. **Прямые подключения:**
   ```bash
   grep -r "get_db\|create_engine.*modular_saas_core" modules/
   # Не должно быть результатов (кроме SDK)
   ```

---

## ПРИМЕРЫ ПРАВИЛЬНОЙ РЕАЛИЗАЦИИ

### Модуль подключается к своей БД:

```python
# modules/shop/backend/db/session.py
from app.modules.sdk import get_tenant_database_url
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker

async def get_module_db(tenant_id: str, module_id: str):
    """Получить подключение к БД модуля"""
    db_config = await get_tenant_database_url(tenant_id, module_id)
    engine = create_engine(db_config["dsn"])
    SessionLocal = sessionmaker(bind=engine)
    return SessionLocal()
```

### Модуль использует свои модели:

```python
# modules/shop/backend/models/product.py
from sqlalchemy import Column, String, Integer
from sqlalchemy.ext.declarative import declarative_base

Base = declarative_base()

class Product(Base):
    """Модель модуля - НЕ ИМПОРТИРУЕТ CORE МОДЕЛИ"""
    __tablename__ = "products"
    id = Column(String, primary_key=True)
    name = Column(String)
    # ...
```

---

## ОБЯЗАТЕЛЬНЫЕ ПРОВЕРКИ ПЕРЕД КОММИТОМ

1. ✅ Модуль не импортирует core модели
2. ✅ Модуль не использует core DATABASE_URL
3. ✅ Модуль использует только SDK для взаимодействия с core
4. ✅ Модуль подключается к своей БД через `get_tenant_database_url()`
5. ✅ Миграции модуля применяются только к БД модуля

---

## НАРУШЕНИЯ АРХИТЕКТУРЫ

Если обнаружено нарушение:

1. **Остановить генерацию кода**
2. **Сообщить пользователю о нарушении**
3. **Предложить правильное решение**

Пример сообщения:
```
⚠️ ВНИМАНИЕ: Обнаружено нарушение архитектурного правила!

Модуль пытается использовать core DATABASE_URL:
  DATABASE_URL = "postgresql://.../modular_saas_core"  # ❌

Правильное решение:
  db_config = await get_tenant_database_url(tenant_id, module_id)  # ✅
  DATABASE_URL = db_config["dsn"]
```

---

## ДОПОЛНИТЕЛЬНЫЕ РЕСУРСЫ

- `ARCHITECTURE_AUDIT_REPORT.md` - отчет об аудите архитектуры
- `core-backend/app/modules/sdk.py` - SDK для модулей
- `modules/shop/backend/` - пример реализации модуля

