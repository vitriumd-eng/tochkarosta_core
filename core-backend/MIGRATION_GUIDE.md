# РУКОВОДСТВО ПО МИГРАЦИЯМ ALEMBIC

**Дата:** 2025-01-16  
**Версия:** 1.0.0

---

## БЕЗОПАСНОЕ ПРИМЕНЕНИЕ МИГРАЦИЙ

### Initial Migration (ca5d2b0eba52)

Эта миграция создает все таблицы базы данных. Она **безопасна** для применения на существующих базах данных, так как проверяет наличие таблиц перед их созданием.

---

## ВАРИАНТЫ ПРИМЕНЕНИЯ

### 1. Чистая база данных (рекомендуется)

Если база данных пустая или только что создана:

```bash
cd core-backend
alembic upgrade head
```

Миграция создаст все необходимые таблицы.

---

### 2. Существующая база данных

Если таблицы уже существуют в БД (созданы вручную или через SQL скрипты):

#### Вариант A: Пометка без применения миграции (РЕКОМЕНДУЕТСЯ)

```bash
cd core-backend
alembic stamp head
```

Это пометит БД как находящуюся на текущей ревизии **без применения миграции**. Таблицы останутся нетронутыми.

**Когда использовать:**
- Таблицы уже существуют
- Данные уже есть в БД
- Нужно просто синхронизировать версию Alembic с состоянием БД

#### Вариант B: Применение миграции (безопасно, но проверяет существование)

```bash
cd core-backend
alembic upgrade head
```

Миграция **безопасна** - она проверит существование каждой таблицы перед созданием. Если таблица уже существует, она будет пропущена.

**Когда использовать:**
- Хотите убедиться, что все таблицы созданы
- Не уверены в полноте структуры БД
- Безопаснее: миграция не создаст дубликаты

---

## ПРОВЕРКА СОСТОЯНИЯ

### Проверить текущую ревизию БД

```bash
alembic current
```

### Проверить доступные миграции

```bash
alembic history
```

### Проверить какие миграции применены

```bash
alembic heads
```

---

## ОТКАТ МИГРАЦИЙ (ОСТОРОЖНО!)

### Откат к предыдущей версии

```bash
alembic downgrade -1
```

### Откат всех миграций (УДАЛИТ ВСЕ ТАБЛИЦЫ И ДАННЫЕ!)

```bash
alembic downgrade base
```

**⚠️ ВНИМАНИЕ:** `downgrade` удалит все таблицы и данные! Используйте только на тестовых базах или после резервного копирования.

---

## БЕЗОПАСНОСТЬ МИГРАЦИИ

### Особенности initial migration

1. **Проверка существования таблиц:**
   - Миграция проверяет наличие каждой таблицы перед созданием
   - Если таблица уже существует, она пропускается
   - Нет риска дублирования таблиц

2. **Порядок создания:**
   - Таблицы создаются в правильном порядке с учетом зависимостей
   - Foreign keys создаются только после создания родительских таблиц

3. **Безопасность данных:**
   - Миграция **НЕ удаляет** существующие таблицы
   - Миграция **НЕ изменяет** существующие данные
   - Миграция только **добавляет** отсутствующие таблицы

---

## РЕКОМЕНДАЦИИ

### Для Production

1. **Создайте резервную копию БД** перед применением миграций:
   ```bash
   pg_dump -U user -d modular_saas_core > backup.sql
   ```

2. **Проверьте миграцию на тестовой БД** сначала

3. **Используйте `alembic stamp head`** если таблицы уже существуют

4. **Используйте `alembic upgrade head`** если хотите убедиться в полноте структуры

### Для Development

1. Можно использовать `alembic upgrade head` напрямую - миграция безопасна

2. При необходимости отката используйте `alembic downgrade base` (только на dev!)

---

## УСТРАНЕНИЕ ПРОБЛЕМ

### Ошибка: "Table already exists"

Если получили такую ошибку при `alembic upgrade head`, значит:
- Таблица уже существует, но Alembic не знает о ней
- **Решение:** Используйте `alembic stamp head` чтобы пометить БД

### Ошибка: "No such table"

Если таблица не существует после миграции:
- Проверьте логи миграции
- Убедитесь, что БД подключена правильно
- Попробуйте `alembic upgrade head` снова (миграция идемпотентна)

---

## ПРОВЕРКА РЕЗУЛЬТАТА

После применения миграции проверьте:

```bash
# В psql или другом клиенте PostgreSQL
\dt  # Показать все таблицы
```

Должны существовать следующие таблицы:
- `modules_registry`
- `tenants`
- `users`
- `subscriptions`
- `platform_content`
- `tenant_domains`
- `deleted_accounts_history`
- `audit_logs`
- `module_settings`

---

**Дата создания:** 2025-01-16  
**Статус:** ✅ Безопасная миграция





