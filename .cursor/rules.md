# ================================================================
#     TOCHKAROSTA CORE — SUPER PROMPT FOR CURSOR (MASTER RULESET)
# ================================================================

Ты работаешь над платформой TochkaRosta: Core Backend (FastAPI + async SQLAlchemy).
Ты ДОЛЖЕН строго следовать структуре, архитектуре и правилам этого проекта.

ЭТО — ГЛАВНЫЕ ПРАВИЛА, КОТОРЫЕ НЕЛЬЗЯ НАРУШАТЬ.

---------------------------------------------------------------
  0. ОБЩЕЕ
---------------------------------------------------------------

— Стиль кода: production-level, чистый, структурный.
— НИКОГДА не использовать `...` как шаблон, правило или команду.
— Если встречаешь `...`, это ПРИМЕР или НЕЗАПОЛНЕННЫЙ КОД.
  → Ты обязан заменить `...` на корректный код или `raise NotImplementedError()`.
— Не удаляй функциональный код без причины.
— Не переписывай архитектуру без указаний.

---------------------------------------------------------------
  1. СТРУКТУРА ПРОЕКТА (ОБЯЗАТЕЛЬНАЯ)
---------------------------------------------------------------

core-backend/
    app/
        api/
            v1/
                routes/
        core/
        db/
        models/
        schemas/
        services/
        middleware/
    alembic/
        versions/
    tests/
    Dockerfile
    docker-compose.local.yml
    .env
    .env.example
    requirements.txt
    Makefile
    README.md

Если файл отсутствует — ты должен его создать.
Если структура нарушена — ты обязан исправить её.

---------------------------------------------------------------
  2. ORM / DATABASE
---------------------------------------------------------------

— Использовать только async SQLAlchemy + asyncpg.
— Схема подключения: postgresql+asyncpg://
— Должен существовать:
      app/db/session.py
      app/db/base.py
      app/models/*
— Все модели ДОЛЖНЫ наследоваться от Base.
— ForeignKey, Index, UniqueConstraint — использовать корректно.
— Никакого asyncpg напрямую — только через SQLAlchemy.

---------------------------------------------------------------
  3. ALEMBIC / MIGRATIONS
---------------------------------------------------------------

— Должен существовать корректный alembic/env.py.
— Если миграции отсутствуют — создать initial migration.
— Если модель изменилась — сгенерировать новую миграцию.
— Запрещено оставлять пустые миграции.
— В env.py обязан быть рантайм для async SQLAlchemy (sync fallback для Alembic).

---------------------------------------------------------------
  4. AUTH / USERS / TENANTS
---------------------------------------------------------------

Ты обязан соблюдать:

— Модель User
— Модель Tenant
— Модель ModuleRegistry
— JWT auth (access + refresh)
— Password hashing: passlib[bcrypt]
— Multi-tenant context loader
— Autoload modules from /modules/*/manifest.json

Если чего-то не хватает — создать.

---------------------------------------------------------------
  5. MODULE SYSTEM (ОБЯЗАТЕЛЬНО)
---------------------------------------------------------------

Модуль = отдельный пакет:

module_name/
    manifest.json
    backend/
        app/
            main.py

Cursor обязан:

— Распознавать модуль по manifest.json  
— Добавлять модуль в ModuleRegistry при загрузке  
— Никогда не трогать существующие модули, кроме исправлений ошибок  

---------------------------------------------------------------
  6. API VERSIONING
---------------------------------------------------------------

— Основной префикс: /api/v1  
— Если создаётся новая major-версия — /api/v2 (когда нужно)  
— Нельзя удалять старые версии без пометки deprecated  

---------------------------------------------------------------
  7. DOCKER / LOCAL ENV
---------------------------------------------------------------

Cursor обязан:

— Поддерживать docker-compose.local.yml в рабочем состоянии  
— core-backend использует Postgres  
— Автоматически исправлять неправильные команды CMD/ENTRYPOINT  
— Проверять, что .env.example соответствует .env  

---------------------------------------------------------------
  8. TESTS
---------------------------------------------------------------

Для каждого критического блока нужен тест:
— auth тесты
— tenants
— migrations
— API endpoints
— module loader

Если тестов нет — создать базовые.

---------------------------------------------------------------
  9. ОБРАБОТКА ОШИБОК И РЕФАКТОРИНГ
---------------------------------------------------------------

Когда в проекте встречаются:
— обрезанные функции
— синтаксические ошибки
— неправильные импорты
— незавершённые куски кода
— `...`
— `pass` где нельзя  
→ Cursor должен автоматически исправлять их.

При невозможности исправить:

→ Создать файл `errors_faq/<timestamp>.md`  
→ Описать проблему, файл, строку, и причину  
→ НИКОГДА не ломать проект молча  

---------------------------------------------------------------
  10. РЕЗОЛЮЦИЯ НЕПОЛНЫХ ФРАГМЕНТОВ
---------------------------------------------------------------

Если Cursor видит незавершённый код:

Пример:
def get_current_tena
или
engine = create_async_engine(...)

Он обязан:
— восстановить правильный код по контексту,
  либо
— создать корректный заглушечный вариант.

Запрещено оставлять `...`.

---------------------------------------------------------------
  11. ПРИОРИТЕТЫ ПОВЕДЕНИЯ CURSOR
---------------------------------------------------------------

1. Сначала — исправить ошибки.
2. Затем — восстановить структуру.
3. Затем — проверить миграции.
4. Затем — улучшить код, если требуется.
5. Не создавать новую архитектуру без указаний.
6. Всегда следовать структуре TochkaRosta Core.

---------------------------------------------------------------
  12. ПРОВЕРКА НА СОВМЕСТИМОСТЬ ПАКЕТОВ
---------------------------------------------------------------

Cursor обязан:

— Перед добавлением новой зависимости проверять её совместимость  
— Сверять версии с официальной документацией  
— Не обновлять зависимости без причины  
— Использовать стабильные версии  

---------------------------------------------------------------
  13. ПРИМЕРЫ — ЭТО ПРИМЕРЫ, НЕ ПРАВИЛА
---------------------------------------------------------------

Если в проекте или документации встречаются примеры кода:
`...`
`pass`
или укороченные фрагменты —

Cursor НЕ должен использовать это как шаблон для генерации.

---------------------------------------------------------------
  14. ГЛАВНОЕ ПРАВИЛО
---------------------------------------------------------------

Цель Cursor — держать проект:

✓ рабочим  
✓ компилируемым  
✓ запускаемым  
✓ структурно целостным  
✓ в соответствии со спецификацией платформы TochkaRosta  

Правило для переноса дизайна между проектами (чистая переноска)

Правило:
При переносе страниц или компонентов из другого проекта выполнять чистую переноску дизайна. Не копировать код частями — лучше переписать компонент заново, сохраняя внешний вид.

Что является переносимым:

внешний вид интерфейса (дизайн)

разметка и визуальная структура

стили и классы

UI-элементы и композиция

Что НЕ переносится:

бизнес-логика

API-вызовы и загрузка данных

state-менеджеры (Redux, Zustand, Context и т.п.)

сервисы, хелперы, модели

кастомные хуки и внутренние зависимости исходного проекта

Ключевые требования:

Не копировать код кусками.

Если оригинальный компонент слишком связан с логикой — верстать заново по дизайну.

Импорты должны ссылаться только на файлы текущего проекта.

Никаких временных зависимостей от исходного проекта.

Работа с недостающими частями:

Если компонент в исходном проекте содержит функциональность — перенести только UI-часть.

Нужные элементы, которых ещё нет в проекте, создать с нуля.

Если функциональность пока не реализована — поставить заглушку и пометить TODO.

Формат результата:

Интерфейс выглядит как в исходном проекте.

Компоненты написаны с нуля, адаптированы под структуру текущего проекта.

Код чистый, самостоятельный и без неиспользуемых импортов.