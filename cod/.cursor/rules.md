# ======================================================================
#   SUPER-PROMPT ДЛЯ CURSOR — МОДУЛЬНАЯ ARХИТЕКТУРА СААS-ПЛАТФОРМЫ
# ======================================================================
Cursor обязан строго следовать этому документу. Никакие изменения структуры,
логики, SDK, портов и поведения без прямого подтверждения пользователя НЕ ДОПУСКАЮТСЯ.
=======================================================================

## 1. НЕИЗМЕННАЯ СТРУКТУРА ПРОЕКТА (эталон)

root/
  core-backend/                         → Python 3.10+, FastAPI, SQLAlchemy, Alembic, PostgreSQL, Redis
    app/
      main.py
      auth/
      billing/
      tenants/
      users/
      subscriptions/
      modules/
        sdk.py                ← backend SDK (обязательно)
        registry.yaml         ← реестр модулей (обязательно)
      logs/                   ← логи ядра + модулей
      metrics/                ← метрики OpenTelemetry
  core-frontend/                        → Next.js (React, TypeScript)
    app/
      page.tsx                 ← публичная страница (порт 7000)
      auth/                    ← регистрация/логин (порт 7001)
      dashboard/               ← панель подписчика (порт 7001)
      admin/                   ← суперадмин (порт 7002)
    lib/
      modules/
        index.ts               ← frontend SDK (обязательно)
      api/
      dtos/
  modules/                              → модули SaaS
    <module-id>/
      backend/
        main.py
        api/
        services/
        models/
        schemas/
        payments/              ← интеграции Юкасса/другие
        ai/                    ← AI-агент (опционально)
      frontend/
        app/
          home/page.tsx
        lib/
          api/
          dtos/
        themes/
          default/
          premium/
          <theme-id>/
      manifest.json
  infra/
    k8s/
    terraform/

⚠ Изменение структуры без разрешения пользователя запрещено.

---

## 2. РОЛИ ЯДРА

Ядро реализует:
✔ мультиарендность и поддомены  
✔ биллинг и подписки  
✔ активацию / деактивацию модулей  
✔ реестр модулей  
✔ выдает временные module_token  
✔ логи и метрики  
✔ уведомления (email/sms/push)  

Ядро НЕ делает:
✗ бизнес-логику модулей  
✗ рендер UI модулей  
✗ управление персоналом и товарами — внутренняя логика модуля  

---

## 3. МОДУЛЬ

Модуль = автономное приложение (shop, events, crm, блог и т.д.).

Модуль обязан содержать:
- backend/
- frontend/
- manifest.json

Модуль работает **только если SDK возвращает, что подписка активна**.

---

## 4. SDK — ЕДИНСТВЕННЫЙ ДОСТУП К ЯДРУ (пример с правильным кодом)

### backend SDK (core-backend/app/modules/sdk.py)
```python
async def get_subscription_status(tenant_id):
    return {"active": True, "module": "shop", "expires": "2025-03-01"}

async def get_tenant_info(tenant_id):
    ...

async def check_dependencies(module_id):
    return {"ok": True, "missing": [], "inactive": []}
```

### ❌ Пример НЕЛЬЗЯ
```python
from core_backend.billing import subscription  # запрещено
```

### frontend SDK (core-frontend/lib/modules/index.ts)
```ts
export async function getSubscriptionStatus() {
  return await fetch("/api/modules/status").then(r => r.json());
}
```

### Использование в модуле
```ts
const sub = await getSubscriptionStatus();
if (!sub.active) return <ModuleLocked />;
```

---

## 5. REGISTRY — ОБЯЗАТЕЛЬНАЯ РЕГИСТРАЦИЯ МОДУЛЕЙ

`core-backend/app/modules/registry.yaml`
```yaml
- id: "shop"
  version: "1.0.0"
  path: "/modules/shop"
  dependencies: ["payments"]

- id: "events"
  version: "1.0.0"
  path: "/modules/events"
  dependencies: ["payments"]
```

Перед регистрацией Cursor выполняет:
✔ проверку существования всех зависимостей  
✔ проверку активности зависимостей по подписке  
✔ проверку циклов  

Если зависимость отсутствует → регистрация запрещена.

---

## 6. MANIFEST — пример корректного заполнения

`modules/events/manifest.json`
```json
{
  "id": "events",
  "name": "Мероприятия",
  "description": "Продажа билетов, регистрация участников",
  "version": "1.0.0",
  "dependencies": ["payments"],
  "publicRoutes": ["/"],
  "dashboardRoutes": ["/admin", "/analytics"],
  "themes": ["default", "premium", "dark"]
}
```

---

## 7. ПОДДОМЕНЫ, ТЕМЫ, ТАРИФЫ (важная логика)

### 7.1 Поддомены
| Тариф | Активные модули | Поддомены одновременно | Заморозка |
|-------|------------------|------------------------|-----------|
| Start | 1 | 2 (1 активный + 1 замороженный) | 15 дней |
| Grow  | 2 | 2 активных | без заморозки |
| Pro   | 3 | 3 активных | без заморозки |

Логика заморозки (только тариф START):
- старый поддомен показывается пользователю как «заморожен»
- не индексируется SEO
- не удаляется пока подписка активна
- удаляется через 15 дней после окончания подписки

И аккаунт подписчика удаляется через 15 дней после окончания подписки.

Регистрация только по номеру телефона — он является логином.

---

### 7.2 Темы модулей
Тема — это **полный UI**, а не просто light/dark.  
При смене модуля автоматически меняется тема.

Хранение:
```
tenant.selectedModule = "events"
tenant.selectedTheme = "premium"
```

---

### 7.3 Персонал и PIN-логин
Персонал авторизуется **по ID модуля + PIN** (не через номер телефона).

Ограничения:
| Тариф | Персонал |
|--------|-----------|
| Start  | 1 |
| Grow   | 5 |
| Pro    | 10+ |

---

### 7.4 AI-ключи
Поддерживаются оба варианта:
- глобальные ключи платформы
- личные ключи подписчика

Если у подписчика есть личный ключ → приоритет его.

---

## 8. ПРОИЗВОДИТЕЛЬНОСТЬ, БЕЗОПАСНОСТЬ, ЛОГИ

Backend:
- PostgreSQL кластер HA + репликация + автоматический failover
- Redis (rate limit, кэш, очереди)
- Celery (асинхронные задачи)

Security:
- JWT RS256 + ротация ключей
- validation Pydantic
- CSP, CORS whitelist
- защита файлов по MIME
- все секреты — Vault/K8s, не в репозитории

Логи:
- JSON, correlation_id
- ошибки → Sentry
- метрики → Prometheus + Grafana

---

## 9. ТИПИЧНЫЕ ОШИБКИ (пример)

| Ошибка | Причина | Решение |
|--------|---------|---------|
| Страница модуля не открывается | не активна подписка | `getSubscriptionStatus()` |
| Сборка Next ломается | неверный путь к модулю | проверить import `/modules/<id>/frontend/...` |
| Модуль не регистрируется | отсутствует зависимость | исправить `dependencies` в manifest |
| AI не работает | нет ключей | предоставить глобальный или личный ключ |

---

## 10. ЧТО Cursor ДОЛЖЕН / НЕ ДОЛЖЕН

### Cursor ДОЛЖЕН
✔ спрашивать подтверждение перед удалением или перезаписью файла  
✔ проверять зависимости при каждой регистрации модуля  
✔ запускать тесты при изменениях SDK  

### Cursor НЕ ДОЛЖЕН
✗ менять структуру проекта  
✗ создавать модуль без manifest.json  
✗ редактировать registry.yaml автоматически  
✗ импортировать ядро в модули  

---

# ВЫВОД
Этот документ — **единственный источник правды**.  
Любые действия Cursor должны соответствовать ему на 100%.  
Если что-то не описано → требуется уточнение у пользователя.

# ======================================================================
#     ЭТО ФИНАЛЬНЫЙ SUPER-PROMPT CURSOR — НИЧЕГО НЕ ИЗМЕНЯТЬ БЕЗ РАЗРЕШЕНИЯ
# ======================================================================
